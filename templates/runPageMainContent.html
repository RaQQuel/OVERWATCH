{# Display histograms here #}
<h1 id="mainContentTitle">{{ run.prettyName }}</h1>
<p>
    {{ run.prettyName }} started at {{ subsystem.prettyPrintUnixTime(subsystem.startOfRun) }} (CERN time zone).</br>
   <a target="_blank" href="https://alice-logbook.cern.ch/logbook/date_online.php?p_cont=rund&p_run={{ run.runNumber }}">Logbook entry</a>
</p>
{%- if timeSlice != None -%}
<p>
    {#subsystem.timeSlices: {{ subsystem.timeSlices }}
    timeSlice: {{ timeSlice }} #}
    Time slice requested {{ timeSlice.timeInMinutesRounded(timeSlice.minUnixTimeRequested) }} to {{ timeSlice.timeInMinutesRounded(timeSlice.maxUnixTimeRequested) }} minutes and returned {{ timeSlice.timeInMinutesRounded(timeSlice.minUnixTimeAvailable) }} to {{ timeSlice.timeInMinutesRounded(timeSlice.maxUnixTimeAvailable) }}.
</p>
{%- endif -%}
<hr />

{# NOTE: We cannot use loop.first because we loop through many empty histGroups! #}
{# See: https://stackoverflow.com/a/4880398 #}
{% set firstLoopCompleted = [] %}
{% set threshold = [] %}
{% for histGroupName, histGroup in subsystem.histGroups.iteritems() %}
    {% if selectedHistGroup == histGroupName or (selectedHistGroup == None and firstLoopCompleted == []) %}
        {%- for histName in histGroup.histList -%}
            {%- set hist = subsystem.hists[histName] %}
            {% if selectedHist == hist.histName or selectedHist == None %}
                {% if histGroup.plotInGrid == False or (histGroup.plotInGrid == True and firstLoopCompleted == []) %}
                    {# Effective increments our counter #}
                    {% if firstLoopCompleted.append(1) %}{% endif %}
                    <a class="histAnchor" data-histname="{{ hist.histName }}" data-histgroup="{{ histGroup.selectionPattern }}" name="{{ hist.histName }}"></a>
                    {% if histGroup.plotInGrid == True -%}
                        <h2>{{ histGroup.prettyName }}</h2>
                    {%- else -%}
                        <h2>{{ hist.prettyName }}</h2>
                    {%- endif %}
                    {% if hist.information != dict() %}
                        {% for label, info in hist.information.iteritems() %}
                        {# Get threshold value if it exists #}
                        {%- if label == "Threshold" -%}
                            {% if threshold.append(info) %}{% endif %}
                        {%- endif -%}
                        <paper-button class="collapsibleContainerButton" id="collapse{{ loop.index0 }}Button{{ hist.histName }}">
                            <div>{{ label }}</div>
                            <paper-icon-button class="collapsibleContainerIcon" icon="icons:arrow-drop-down"></paper-icon-button>
                        </paper-button>
                        <iron-collapse class="collapsibleContainer" id="collapse{{ loop.index0 }}{{ hist.histName }}">
                            <div>{{ info }}</div>
                        </iron-collapse>
                        <br />
                        {% endfor %}
                    {% endif %}
                {% endif %}
                {# If grid, then add class #}
                {%- set histogramContainerClasses = "histogramContainer" -%}
                {% if histGroup.plotInGrid == True %}
                    {# TODO: Determine how to properly show the grid with iron-flex-layout #}
                    <p>Grid!</p>
                {% endif %}
                <div id="{{ hist.histName }}" class="{%- if jsRoot == True -%}{{ histogramContainerClasses }}{%- endif -%}" data-filename="{{ jsonFilenameTemplate.format(hist.histName.replace("/", "_")) }}">
                {% if jsRoot != True %}
                    <img src="{{ url_for("protected", filename=imgFilenameTemplate.format(hist.histName.replace("/", "_"))) }}" alt="{{ hist.histName }}">
                {% else %}
                    {# Provide indication that we are loading jsroot content #}
                    {# It will disappear once jsroot loads the histogram #}
                    <p>Loading...</p>
                {% endif %}
                </div>
            {% endif %}
        {% endfor -%}
    {% endif %}
{% endfor %}

{# Content for time dependent merge #}
{# TODO: Set minTime and maxTime (which are the default value of the sliders) dynamic for time slices #}
<div class="hideElement" id="timeSlicesValues" data-mintime="0" data-maxtime="{{ subsystem.runLength }}" data-runlength="{{ subsystem.runLength }}" data-hotchannelthreshold="{%- if threshold != [] -%}{{ threshold[0]*1000 }}{%- else -%}0{%- endif -%}" data-runnumber="{{ run.runDir }}" data-subsystem="{{ subsystem.subsystem }}" data-histname="{{ selectedHist }}" data-histgroupname="{{ selectedHistGroup }}"></div>
