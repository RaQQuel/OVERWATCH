# Docker file for the OVERWATCH web app
FROM rehlers/overwatch-base:latest
LABEL maintainer Raymond Ehlers <raymond.ehlers@cern.ch>, Yale University

# Setup OVERWATCH
ENV OVERWATCH_ROOT /opt/overwatch
WORKDIR ${OVERWATCH_ROOT}
# Ensure that ROOT is found by cmake
ENV ROOTSYS /opt/root
# Download OVERWATCH, setup the needed python packages, and compile the reciever
# Size increase here is mainly due to numpy
RUN git clone https://github.com/raymondEhlers/OVERWATCH.git . \
        && pip install --upgrade pip \
        && pip install -r requirements.txt \
        && mkdir -p receiver/build && cd receiver/build \
        && cmake "../" -DCMAKE_INSTALL_PREFIX="../" -DZEROMQ="/usr" \
        && make install

# Add bower, Polymer, webcomponents, jsRoot for OVERWATCH
RUN ln -s /usr/bin/nodejs /usr/bin/node \
        && npm install -g bower \
        && cd webApp/static \
        && bower --allow-root install \
        && cd /tmp && git clone https://github.com/root-project/jsroot.git \
        && cp -r jsroot/scripts ${OVERWATCH_ROOT}/webApp/static/. && cp -r jsroot/style ${OVERWATCH_ROOT}/webApp/static/. \
        && rm -r /tmp/jsroot
        # Need to patch JsRootPainter.more.js
        #&& cd jsroot && git apply ${OVERWATCH_ROOT}/deploy/docker/jsRootPainterMoreDrawPaveFix.patch \

# Configure nginx
# Make NGINX run on the foreground and remove default site config
# Need -f since the file may not exist!
RUN echo "daemon off;" >> /etc/nginx/nginx.conf && rm /etc/nginx/sites-enabled/default
# Copy in nginx and gzip config
COPY nginxConf/*.conf /etc/nginx/conf.d/
COPY nginx.conf /etc/nginx/sites-enabled/.

# Configure OVERWATCH
# This file should be generated by setupServerParams.sh
COPY serverParams.py /opt/overwatch/config/.
# Ensure that the proper configuration file is setup. The values should already be in the file!
RUN cp /opt/overwatch/deploy/configOVERWATCH_stub.sh /opt/overwatch/deploy/configOVERWATCH.sh
# Check for whether we are running with debug!
# TODO: Compile overwatch docs so that they are accessible for a docker hosted site!

# Configure supervisord
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# TEMP
# NOTE: Will cause a problem if we make changes to the receiver
RUN git checkout deploy2017
# vim can always be installed later...
# ENDTEMP

# Expose the ports for nginx and ZODB
EXPOSE 80 8090
CMD ["/usr/bin/supervisord"]
